<% provide(:title, "StuffInfo") %>

<h1>Information</h1>
<div class="table-responsive">
  <table class="dataTable table table-hover" id="stufflist">
    <thead>
    <tr>
      <th>姓名</th>
      <th>性别</th>
      <th>中心</th>
      <th>联系电话</th>
      <th>邮箱</th>
      <th>QQ</th>
      <th>获奖记录</th>
      <th>排班</th>
    </tr>
    </thead>
    <tbody>
    <% @users.each do |u| %>
        <tr>
          <td><%= u.name %></td>
          <td><%= u.sex %></td>
          <td><%= u.center %></td>
          <td><%= u.tel %></td>
          <td><%= u.email %></td>
          <td><%= u.qq %></td>
          <td><button type="button" class="btn btn-default" data-container="body" data-toggle="popover" data-placement="left" data-content="
          <% u.awards.each do |a| %>
            <%= a.record %>
            <br />
          <% end %>">
            获奖记录
          </button>
          </td>
          <td>
            <button class="btn btn-default duty" data-toggle="modal" data-target="#myModal"  data-user="<%= u.id %>">排班</button>
          </td>
        </tr>
    <% end %>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel" style="text-align: center"></h4>
      </div>
      <div class="modal-body">
        <input type="hidden" id="userId" value="">
        <table class="table table-striped table-bordered">
          <tr>
            <td class="date1"></td>
            <td class="date2"></td>
            <td class="date3"></td>
            <td class="date4"></td>
            <td class="date5"></td>
            <td class="date6"></td>
            <td class="date7"></td>
          </tr>
          <tr>
            <td class="duty1"></td>
            <td class="duty2"></td>
            <td class="duty3"></td>
            <td class="duty4"></td>
            <td class="duty5"></td>
            <td class="duty6"></td>
            <td class="duty7"></td>
          </tr>
          <tr>
            <td class="date8"></td>
            <td class="date9"></td>
            <td class="date10"></td>
            <td class="date11"></td>
            <td class="date12"></td>
            <td class="date13"></td>

            <td class="date14"></td>
          </tr>
          <tr>
            <td class="duty8"></td>
            <td class="duty9"></td>
            <td class="duty10"></td>
            <td class="duty11"></td>
            <td class="duty12"></td>
            <td class="duty13"></td>
            <td class="duty14"></td>
          </tr>
          <tr>
            <td class="date15"></td>
            <td class="date16"></td>
            <td class="date17"></td>
            <td class="date18"></td>
            <td class="date19"></td>
            <td class="date20"></td>
            <td class="date21"></td>
          </tr>
          <tr>
            <td class="duty15"></td>
            <td class="duty16"></td>
            <td class="duty17"></td>
            <td class="duty18"></td>
            <td class="duty19"></td>
            <td class="duty20"></td>



            <td class="duty21"></td>
          </tr>
          <tr>

            <td class="date22"></td>
            <td class="date23"></td>
            <td class="date24"></td>
            <td class="date25"></td>
            <td class="date26"></td>
            <td class="date27"></td>
            <td class="date28"></td>
          </tr>
          <tr>
            <td class="duty22"></td>
            <td class="duty23"></td>
            <td class="duty24"></td>
            <td class="duty25"></td>
            <td class="duty26"></td>
            <td class="duty27"></td>
            <td class="duty28"></td>
          </tr>
          <tr>
            <td class="date29"></td>
            <td class="date30"></td>
            <td class="date31"></td>
          </tr>
          <tr>
            <td class="duty29"></td>
            <td class="duty30"></td>
            <td class="duty31"></td>
          </tr>
            </table>
        </div>
      <div class="modal-footer">
        <label class="name" style="margin-right: 400px;"></label>
        <button type="button" id="pre" class="btn btn-default"><-</button>
        <button type="button" id="next" class="btn btn-default">-></button>
      </div>
    </div>
  </div>
  </div>
<script>
  $(document).ready(function(){

      setTableContent = function(data) {
          $(".modal-body td").text("");
          if (data[0] == undefined) return;
          for (var i = 0; i <  data.length; i++) {
              $(".date" + (i + 1)).text(data[i].date.toString().substring(6, 8));
              $(".duty" + (i + 1)).text(data[i].duty);
          }
      }

      $('button').popover({html:true});
      $('.duty').click(function() {
          var date = new Date();
          var year = date.getFullYear();
          var month = (Array(2).join(0) + (date.getMonth() + 1)).slice(-2);
          var yearMonth = year + month;
          $('#myModalLabel').html(yearMonth);
          $("#userId").val($(this).data('user'));

//       alert(yearMonth);
          $.ajax({
              url:'/info_manages/get_duty?month=' + yearMonth + '&id=' + $(this).data('user'),
              dataType: 'json',
              success: function(data) {
                 setTableContent(data);
              }

          }) ;
      });
      $('#pre').click(function(){
          var paramDate =  $('#myModalLabel').html();
          var year = paramDate.substring(0, 4);
          var month = paramDate.substring(4, 6);
          month = parseInt(month) - 1;
          if (month == 0) {
              month = 12;
              year = parseInt(year) - 1;
          }
          var yearMonth = year + (Array(2).join(0) + month).slice(-2);
          $('#myModalLabel').html(yearMonth);
          var userId = $("#userId").val();
          $.ajax({
              url:'/info_manages/get_duty?month=' + yearMonth +'&id=' + userId,
              dataType: 'json',
              success: function(data) {
                 setTableContent(data);
              }
          });
      });
      $('#next').click(function(){
          var paramDate =  $('#myModalLabel').html();
          var year = paramDate.substring(0, 4);
          var month = paramDate.substring(4, 6);
          month = parseInt(month) + 1;
          if (month == 13) {
              year = parseInt(year) + 1;
              month = 1;
          }
          var yearMonth = year + (Array(2).join(0) + month).slice(-2);
          $('#myModalLabel').html(yearMonth);
          var userId = $("#userId").val();
          $.ajax({
              url:'/info_manages/get_duty?month=' + yearMonth +'&id=' + userId,
              dataType: 'json',
              success: function(data) {
                 setTableContent(data);
              }
          });
      });
  });


</script>